<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications - Study Schedule Therapy</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">
                <i class="fas fa-brain me-2"></i>Study Schedule Therapy
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="schedules.html">Schedules</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="groups.html">Groups</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="sessions.html">Sessions</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="notifications.html">
                            <i class="fas fa-bell me-1"></i>
                            <span id="navNotificationBadge" style="display: none;" class="badge bg-danger rounded-pill ms-1">0</span>
                            Notifications
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="ai-dashboard.html">
                            <i class="fas fa-robot me-1"></i>AI Assistant
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav" id="authNav">
                    <!-- Will be populated by auth system -->
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-8">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-bell me-2"></i>Notifications</h2>
                    <div>
                        <button class="btn btn-outline-primary btn-sm me-2" onclick="loadNotifications()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-outline-success btn-sm me-2" onclick="markAllAsRead()" id="markAllBtn">
                            <i class="fas fa-check-double"></i> Mark All Read
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="toggleNotificationPermission()" id="permissionBtn">
                            <i class="fas fa-desktop"></i> Enable Notifications
                        </button>
                    </div>
                </div>

                <!-- Filter Tabs -->
                <ul class="nav nav-tabs mb-4" id="notificationTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all"
                                type="button" role="tab" onclick="loadNotifications('all')">
                            All <span class="badge bg-secondary ms-1" id="allCount">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="unread-tab" data-bs-toggle="tab" data-bs-target="#unread"
                                type="button" role="tab" onclick="loadNotifications('unread')">
                            Unread <span class="badge bg-danger ms-1" id="unreadCount">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="recent-tab" data-bs-toggle="tab" data-bs-target="#recent"
                                type="button" role="tab" onclick="loadNotifications('recent')">
                            Recent <span class="badge bg-info ms-1" id="recentCount">0</span>
                        </button>
                    </li>
                </ul>

                <!-- Notifications List -->
                <div class="tab-content" id="notificationTabContent">
                    <div class="tab-pane fade show active" id="all" role="tabpanel">
                        <div id="notificationsList">
                            <!-- Notifications will be loaded here -->
                            <div class="text-center py-5" id="loadingSpinner">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">Loading notifications...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="text-center py-5" style="display: none;">
                    <i class="fas fa-bell-slash fa-4x text-muted mb-3"></i>
                    <h4 class="text-muted">No Notifications</h4>
                    <p class="text-muted">You're all caught up! Check back later for new updates.</p>
                    <button class="btn btn-primary" onclick="createTestNotification()">
                        <i class="fas fa-plus"></i> Create Test Notification
                    </button>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Quick Stats -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="fas fa-chart-bar me-2"></i>Notification Stats</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <h4 class="text-primary" id="totalNotifications">0</h4>
                                <small class="text-muted">Total</small>
                            </div>
                            <div class="col-4">
                                <h4 class="text-danger" id="unreadNotifications">0</h4>
                                <small class="text-muted">Unread</small>
                            </div>
                            <div class="col-4">
                                <h4 class="text-info" id="recentNotifications">0</h4>
                                <small class="text-muted">Recent</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notification Types -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="fas fa-tags me-2"></i>Notification Types</h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span><i class="fas fa-calendar-alt text-primary me-2"></i>Study Reminders</span>
                                <span class="badge bg-primary rounded-pill" id="scheduleCount">0</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span><i class="fas fa-clock text-info me-2"></i>Session Reminders</span>
                                <span class="badge bg-info rounded-pill" id="sessionCount">0</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span><i class="fas fa-users text-success me-2"></i>Group Invitations</span>
                                <span class="badge bg-success rounded-pill" id="groupCount">0</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span><i class="fas fa-exclamation-triangle text-warning me-2"></i>Deadlines</span>
                                <span class="badge bg-warning rounded-pill" id="deadlineCount">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="fas fa-cog me-2"></i>Settings</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="browserNotifications" onchange="handleNotificationSettings()">
                            <label class="form-check-label" for="browserNotifications">
                                Browser Notifications
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="autoRefresh" checked onchange="handleAutoRefresh()">
                            <label class="form-check-label" for="autoRefresh">
                                Auto Refresh
                            </label>
                        </div>
                        <div class="mb-2">
                            <label for="refreshInterval" class="form-label">Refresh Interval (seconds)</label>
                            <input type="range" class="form-range" id="refreshInterval" min="10" max="120" value="30" onchange="handleRefreshInterval()">
                            <small class="text-muted" id="intervalDisplay">30 seconds</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Delete Notification</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this notification? This action cannot be undone.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="notification-service.js"></script>
    <script src="global-auth.js"></script>
    <script>
        let currentFilter = 'all';
        let notifications = [];
        let notificationToDelete = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeNotifications();
        });

        async function initializeNotifications() {
            await loadNotifications();
            await updateStats();
            setupAutoRefresh();
            checkNotificationPermission();

            // Start polling for new notifications
            notificationService.startPolling();
        }

        async function loadNotifications(filter = 'all') {
            currentFilter = filter;
            showLoading();

            try {
                let data;
                switch (filter) {
                    case 'unread':
                        data = await notificationService.getUnreadNotifications();
                        break;
                    case 'recent':
                        data = await notificationService.getRecentNotifications();
                        break;
                    default:
                        data = await notificationService.getNotifications();
                }

                notifications = data;
                renderNotifications(data);
                await updateStats();
            } catch (error) {
                console.error('Error loading notifications:', error);
                showError('Failed to load notifications');
            }
        }

        function renderNotifications(notificationList) {
            const container = document.getElementById('notificationsList');
            const emptyState = document.getElementById('emptyState');

            if (!notificationList || notificationList.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            const html = notificationList.map(notification => `
                <div class="card mb-3 notification-item ${!notification.isRead ? 'border-primary' : ''}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="${notificationService.getNotificationIcon(notification.type)} me-2"></i>
                                    <h6 class="mb-0 ${!notification.isRead ? 'fw-bold' : ''}">${notification.title}</h6>
                                    ${!notification.isRead ? '<span class="badge bg-primary ms-2">New</span>' : ''}
                                </div>
                                <p class="mb-2 text-muted">${notification.message}</p>
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>
                                    ${notificationService.formatNotificationTime(notification.createdAt)}
                                </small>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    ${!notification.isRead ? `
                                        <li><a class="dropdown-item" href="#" onclick="markAsRead(${notification.id})">
                                            <i class="fas fa-check me-2"></i>Mark as Read
                                        </a></li>
                                    ` : ''}
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteNotification(${notification.id})">
                                        <i class="fas fa-trash me-2"></i>Delete
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        async function updateStats() {
            try {
                const allNotifications = await notificationService.getNotifications();
                const unreadNotifications = await notificationService.getUnreadNotifications();
                const recentNotifications = await notificationService.getRecentNotifications();

                // Update counts
                document.getElementById('totalNotifications').textContent = allNotifications.length;
                document.getElementById('unreadNotifications').textContent = unreadNotifications.length;
                document.getElementById('recentNotifications').textContent = recentNotifications.length;

                // Update tab badges
                document.getElementById('allCount').textContent = allNotifications.length;
                document.getElementById('unreadCount').textContent = unreadNotifications.length;
                document.getElementById('recentCount').textContent = recentNotifications.length;

                // Update type counts
                const typeCounts = {
                    'SCHEDULE_REMINDER': 0,
                    'SESSION_REMINDER': 0,
                    'GROUP_INVITATION': 0,
                    'DEADLINE_WARNING': 0
                };

                allNotifications.forEach(notification => {
                    if (typeCounts.hasOwnProperty(notification.type)) {
                        typeCounts[notification.type]++;
                    }
                });

                document.getElementById('scheduleCount').textContent = typeCounts['SCHEDULE_REMINDER'];
                document.getElementById('sessionCount').textContent = typeCounts['SESSION_REMINDER'];
                document.getElementById('groupCount').textContent = typeCounts['GROUP_INVITATION'];
                document.getElementById('deadlineCount').textContent = typeCounts['DEADLINE_WARNING'];

                // Update navigation badge
                await notificationService.updateNotificationBadge();

                // Show/hide mark all as read button
                const markAllBtn = document.getElementById('markAllBtn');
                markAllBtn.style.display = unreadNotifications.length > 0 ? 'inline-block' : 'none';

            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        async function markAsRead(notificationId) {
            try {
                await notificationService.markAsRead(notificationId);
                await loadNotifications(currentFilter);
                showSuccess('Notification marked as read');
            } catch (error) {
                showError('Failed to mark notification as read');
            }
        }

        async function markAllAsRead() {
            try {
                await notificationService.markAllAsRead();
                await loadNotifications(currentFilter);
                showSuccess('All notifications marked as read');
            } catch (error) {
                showError('Failed to mark all notifications as read');
            }
        }

        function deleteNotification(notificationId) {
            notificationToDelete = notificationId;
            const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
            modal.show();
        }

        async function confirmDelete() {
            if (notificationToDelete) {
                try {
                    await notificationService.deleteNotification(notificationToDelete);
                    await loadNotifications(currentFilter);
                    showSuccess('Notification deleted successfully');

                    const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                    modal.hide();
                } catch (error) {
                    showError('Failed to delete notification');
                }
                notificationToDelete = null;
            }
        }

        async function createTestNotification() {
            const types = ['SCHEDULE_REMINDER', 'SESSION_REMINDER', 'GROUP_INVITATION', 'DEADLINE_WARNING', 'STUDY_TIP', 'SYSTEM_NOTIFICATION'];
            const randomType = types[Math.floor(Math.random() * types.length)];
            const title = 'Test Notification';
            const message = 'This is a test notification to demonstrate the notification system.';

            try {
                await notificationService.createTestNotification(title, message, randomType);
                await loadNotifications(currentFilter);
                showSuccess('Test notification created');
            } catch (error) {
                showError('Failed to create test notification');
            }
        }

        async function toggleNotificationPermission() {
            const hasPermission = await notificationService.requestNotificationPermission();
            checkNotificationPermission();

            if (hasPermission) {
                showSuccess('Browser notifications enabled');
            } else {
                showError('Browser notifications permission denied');
            }
        }

        function checkNotificationPermission() {
            const permissionBtn = document.getElementById('permissionBtn');
            const browserNotificationsCheck = document.getElementById('browserNotifications');

            if ('Notification' in window) {
                const hasPermission = Notification.permission === 'granted';
                browserNotificationsCheck.checked = hasPermission;
                permissionBtn.innerHTML = hasPermission ?
                    '<i class="fas fa-check"></i> Notifications Enabled' :
                    '<i class="fas fa-desktop"></i> Enable Notifications';
                permissionBtn.className = hasPermission ? 'btn btn-success btn-sm' : 'btn btn-outline-secondary btn-sm';
            } else {
                permissionBtn.style.display = 'none';
                browserNotificationsCheck.parentElement.style.display = 'none';
            }
        }

        function handleNotificationSettings() {
            const enabled = document.getElementById('browserNotifications').checked;
            if (enabled && Notification.permission !== 'granted') {
                toggleNotificationPermission();
            }
        }

        function handleAutoRefresh() {
            const enabled = document.getElementById('autoRefresh').checked;
            if (enabled) {
                notificationService.startPolling();
                showSuccess('Auto refresh enabled');
            } else {
                notificationService.stopPolling();
                showSuccess('Auto refresh disabled');
            }
        }

        function handleRefreshInterval() {
            const interval = document.getElementById('refreshInterval').value;
            document.getElementById('intervalDisplay').textContent = `${interval} seconds`;
            notificationService.pollingFrequency = interval * 1000;

            if (document.getElementById('autoRefresh').checked) {
                notificationService.startPolling();
            }
        }

        function setupAutoRefresh() {
            const autoRefreshCheck = document.getElementById('autoRefresh');
            if (autoRefreshCheck.checked) {
                notificationService.startPolling();
            }
        }

        function showLoading() {
            document.getElementById('loadingSpinner').style.display = 'block';
        }

        function showError(message) {
            // You can implement a toast notification system here
            console.error(message);
            alert('Error: ' + message);
        }

        function showSuccess(message) {
            // You can implement a toast notification system here
            console.log(message);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            notificationService.stopPolling();
        });
    </script>
</body>
</html>
